#!/usr/bin/env bash

set -e

BLUE='\033[0;34m'
NC='\033[0m' # No Color

function info() {
    echo -e "$BLUE$1$NC"
}

if [[ -z "$NVIM_INSTALL_PREFIX" ]]; then
    # Get sudo
    sudo true
    SUDO_OPT=sudo
else
    SUDO_OPT=""
fi

BUILD_DIR=/tmp/nvim_build

rm -f $BUILD_DIR.log

if [[ ! -d "$BUILD_DIR/.git" ]]; then
    rm -rf $BUILD_DIR
    info "Cloning neovim"
    git clone https://github.com/neovim/neovim \
        --depth 1 \
        --quiet \
        $BUILD_DIR \
        >> $BUILD_DIR.log
fi

cd $BUILD_DIR

info "Pulling updates"
git pull \
    >> $BUILD_DIR.log

info "Cleaning workspace"
make distclean \
    >> $BUILD_DIR.log

info "Building"
make CMAKE_BUILD_TYPE=RelWithDebInfo \
    >> $BUILD_DIR.log

info "Installing"
$SUDO_OPT make \
    CMAKE_BUILD_TYPE=RelWithDebInfo \
    "CMAKE_INSTALL_PREFIX=$NVIM_INSTALL_PREFIX" \
    install \
    >> $BUILD_DIR.log

info "Done!"
